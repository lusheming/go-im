<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
        input, button { margin: 5px; padding: 8px; }
        .status { font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>🚀 WebSocket 连接测试</h1>
    
    <div class="section">
        <h3>1. 用户注册/登录</h3>
        <input id="username" placeholder="用户名" value="testuser1">
        <input id="password" placeholder="密码" value="123456" type="password">
        <button onclick="register()">注册</button>
        <button onclick="login()">登录</button>
        <br>
        <input id="token" placeholder="JWT Token" style="width: 400px;">
        <input id="userId" placeholder="User ID" readonly>
    </div>

    <div class="section">
        <h3>2. WebSocket 连接</h3>
        <input id="wsUrl" value="ws://localhost:8080/ws" style="width: 300px;">
        <button onclick="connectWS()" id="connectBtn">连接</button>
        <span id="wsStatus" class="status">未连接</span>
    </div>

    <div class="section">
        <h3>3. 好友管理</h3>
        <input id="friendId" placeholder="好友ID" value="testuser2">
        <button onclick="addFriend()">加好友</button>
    </div>

    <div class="section">
        <h3>4. 消息发送</h3>
        <input id="toUserId" placeholder="接收者ID" value="testuser2">
        <input id="messageText" placeholder="消息内容" value="Hello World!">
        <button onclick="sendMessage()">发送消息</button>
    </div>

    <div class="section">
        <h3>5. 日志输出</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        let ws = null;
        let token = '';
        let userId = '';

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.textContent += `[${now}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nickname: username })
                });
                const result = await response.json();
                log(`注册结果: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ 注册失败: ${error.message}`);
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                log(`登录结果: ${JSON.stringify(result)}`);
                
                if (result.token) {
                    token = result.token;
                    userId = result.userId;
                    document.getElementById('token').value = token;
                    document.getElementById('userId').value = userId;
                    log(`✅ 登录成功 - UserID: ${userId}`);
                }
            } catch (error) {
                log(`❌ 登录失败: ${error.message}`);
            }
        }

        async function addFriend() {
            const friendId = document.getElementById('friendId').value;
            
            if (!token) {
                log('❌ 请先登录');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/friends', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ friendID: friendId, remark: '' })
                });
                const result = await response.json();
                log(`加好友结果: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ 加好友失败: ${error.message}`);
            }
        }

        function connectWS() {
            if (!token) {
                log('❌ 请先登录获取 token');
                return;
            }

            const wsUrl = document.getElementById('wsUrl').value;
            const url = `${wsUrl}?token=${token}&deviceId=test-device-${Date.now()}`;
            
            log(`正在连接 WebSocket: ${url}`);
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                log('✅ WebSocket 连接成功');
                document.getElementById('wsStatus').textContent = '已连接';
                document.getElementById('wsStatus').className = 'status success';
                document.getElementById('connectBtn').textContent = '重连';
            };
            
            ws.onclose = () => {
                log('❌ WebSocket 连接关闭');
                document.getElementById('wsStatus').textContent = '未连接';
                document.getElementById('wsStatus').className = 'status error';
                document.getElementById('connectBtn').textContent = '连接';
            };
            
            ws.onerror = (error) => {
                log(`❌ WebSocket 错误: ${error}`);
            };
            
            ws.onmessage = (event) => {
                log(`📩 收到消息: ${event.data}`);
                
                try {
                    const message = JSON.parse(event.data);
                    if (message.action === 'ack') {
                        log(`✅ 消息发送成功 - Seq: ${message.data.seq}`);
                    } else if (message.action === 'error') {
                        log(`❌ 消息发送失败: ${message.data.message || message.data.code}`);
                    }
                } catch (e) {
                    // 忽略解析错误
                }
            };
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('❌ WebSocket 未连接');
                return;
            }

            const toUserId = document.getElementById('toUserId').value;
            const messageText = document.getElementById('messageText').value;

            if (!toUserId || !messageText) {
                log('❌ 请填写接收者ID和消息内容');
                return;
            }

            const message = {
                action: 'send',
                data: {
                    convId: `conv-${userId}-${toUserId}`,
                    convType: 'c2c',
                    to: toUserId,
                    type: 'text',
                    clientMsgId: `cmid-${Date.now()}`,
                    payload: { text: messageText }
                }
            };

            log(`→ 发送消息: ${JSON.stringify(message)}`);
            ws.send(JSON.stringify(message));
        }
    </script>
</body>
</html> 