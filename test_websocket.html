<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
        input, button { margin: 5px; padding: 8px; }
        .status { font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸš€ WebSocket è¿æ¥æµ‹è¯•</h1>
    
    <div class="section">
        <h3>1. ç”¨æˆ·æ³¨å†Œ/ç™»å½•</h3>
        <input id="username" placeholder="ç”¨æˆ·å" value="testuser1">
        <input id="password" placeholder="å¯†ç " value="123456" type="password">
        <button onclick="register()">æ³¨å†Œ</button>
        <button onclick="login()">ç™»å½•</button>
        <br>
        <input id="token" placeholder="JWT Token" style="width: 400px;">
        <input id="userId" placeholder="User ID" readonly>
    </div>

    <div class="section">
        <h3>2. WebSocket è¿æ¥</h3>
        <input id="wsUrl" value="ws://localhost:8080/ws" style="width: 300px;">
        <button onclick="connectWS()" id="connectBtn">è¿æ¥</button>
        <span id="wsStatus" class="status">æœªè¿æ¥</span>
    </div>

    <div class="section">
        <h3>3. å¥½å‹ç®¡ç†</h3>
        <input id="friendId" placeholder="å¥½å‹ID" value="testuser2">
        <button onclick="addFriend()">åŠ å¥½å‹</button>
    </div>

    <div class="section">
        <h3>4. æ¶ˆæ¯å‘é€</h3>
        <input id="toUserId" placeholder="æ¥æ”¶è€…ID" value="testuser2">
        <input id="messageText" placeholder="æ¶ˆæ¯å†…å®¹" value="Hello World!">
        <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    </div>

    <div class="section">
        <h3>5. æ—¥å¿—è¾“å‡º</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let ws = null;
        let token = '';
        let userId = '';

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.textContent += `[${now}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nickname: username })
                });
                const result = await response.json();
                log(`æ³¨å†Œç»“æœ: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`âŒ æ³¨å†Œå¤±è´¥: ${error.message}`);
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                log(`ç™»å½•ç»“æœ: ${JSON.stringify(result)}`);
                
                if (result.token) {
                    token = result.token;
                    userId = result.userId;
                    document.getElementById('token').value = token;
                    document.getElementById('userId').value = userId;
                    log(`âœ… ç™»å½•æˆåŠŸ - UserID: ${userId}`);
                }
            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function addFriend() {
            const friendId = document.getElementById('friendId').value;
            
            if (!token) {
                log('âŒ è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/friends', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ friendID: friendId, remark: '' })
                });
                const result = await response.json();
                log(`åŠ å¥½å‹ç»“æœ: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`âŒ åŠ å¥½å‹å¤±è´¥: ${error.message}`);
            }
        }

        function connectWS() {
            if (!token) {
                log('âŒ è¯·å…ˆç™»å½•è·å– token');
                return;
            }

            const wsUrl = document.getElementById('wsUrl').value;
            const url = `${wsUrl}?token=${token}&deviceId=test-device-${Date.now()}`;
            
            log(`æ­£åœ¨è¿æ¥ WebSocket: ${url}`);
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                log('âœ… WebSocket è¿æ¥æˆåŠŸ');
                document.getElementById('wsStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('wsStatus').className = 'status success';
                document.getElementById('connectBtn').textContent = 'é‡è¿';
            };
            
            ws.onclose = () => {
                log('âŒ WebSocket è¿æ¥å…³é—­');
                document.getElementById('wsStatus').textContent = 'æœªè¿æ¥';
                document.getElementById('wsStatus').className = 'status error';
                document.getElementById('connectBtn').textContent = 'è¿æ¥';
            };
            
            ws.onerror = (error) => {
                log(`âŒ WebSocket é”™è¯¯: ${error}`);
            };
            
            ws.onmessage = (event) => {
                log(`ğŸ“© æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
                
                try {
                    const message = JSON.parse(event.data);
                    if (message.action === 'ack') {
                        log(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸ - Seq: ${message.data.seq}`);
                    } else if (message.action === 'error') {
                        log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${message.data.message || message.data.code}`);
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            };
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocket æœªè¿æ¥');
                return;
            }

            const toUserId = document.getElementById('toUserId').value;
            const messageText = document.getElementById('messageText').value;

            if (!toUserId || !messageText) {
                log('âŒ è¯·å¡«å†™æ¥æ”¶è€…IDå’Œæ¶ˆæ¯å†…å®¹');
                return;
            }

            const message = {
                action: 'send',
                data: {
                    convId: `conv-${userId}-${toUserId}`,
                    convType: 'c2c',
                    to: toUserId,
                    type: 'text',
                    clientMsgId: `cmid-${Date.now()}`,
                    payload: { text: messageText }
                }
            };

            log(`â†’ å‘é€æ¶ˆæ¯: ${JSON.stringify(message)}`);
            ws.send(JSON.stringify(message));
        }
    </script>
</body>
</html> 