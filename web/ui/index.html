<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>go-im 测试台</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --surface: #1e293b;
      --surface-hover: #334155;
      --border: #334155;
      --border-light: #475569;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1e293b 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-badge {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr 380px;
      gap: 24px;
      align-items: start;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section {
      margin-bottom: 32px;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      border-radius: 2px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .input-group {
      position: relative;
      flex: 1;
    }

    input, select, textarea {
      width: 100%;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 400;
      transition: all 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 44px;
      box-shadow: var(--shadow);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 12px;
      min-height: 32px;
    }

    .tag {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      margin-right: 8px;
    }

    .status-indicator.offline {
      background: var(--text-muted);
    }

    .log-container {
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .log-container.ws-log {
      height: 300px;
    }

    .video-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .video-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: var(--bg-primary);
      box-shadow: var(--shadow);
      aspect-ratio: 16/9;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 500;
    }

    .section-subtitle {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      border-left: 3px solid var(--primary);
      padding-left: 10px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .video-controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }

    .video-control-btn {
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .video-control-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .video-control-btn.active {
      background: var(--danger);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }

    .stat-item {
      background: var(--surface);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

          .stat-value {
        display: block;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      @keyframes pulse {
        0% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
        }
        50% { 
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(14, 165, 233, 0);
        }
        100% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
        }
      }

    .file-list, .favorite-list, .notice-list {
      max-height: 200px;
      overflow-y: auto;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: var(--bg-primary);
    }

    .file-item, .favorite-item, .notice-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-item:last-child, .favorite-item:last-child, .notice-item:last-child {
      margin-bottom: 0;
    }

    .typing-indicator {
      color: var(--success);
      font-style: italic;
      margin-left: 12px;
      display: none;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .logs-grid {
      display: grid;
      gap: 20px;
    }

    .icon {
      width: 16px;
      height: 16px;
      display: inline-block;
    }

    /* 响应式设计 */
    @media (max-width: 1400px) {
      .main-grid {
        grid-template-columns: 380px 1fr;
      }
      
      .logs-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid-3 {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }
      
      header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      
      .form-grid-3 {
        grid-template-columns: 1fr;
      }
      
      .video-container {
        flex-direction: column;
      }
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    /* 动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      animation: fadeIn 0.3s ease;
    }

    /* 美化文件上传 */
    .file-upload {
      position: relative;
      display: inline-block;
      cursor: pointer;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--bg-primary);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.2s ease;
      color: var(--text-muted);
    }

    .file-upload:hover .file-upload-label {
      border-color: var(--primary);
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
<header>
      <h1>🚀 go-im 测试台</h1>
      <div class="header-badge">v2.0 - 完整功能测试</div>
</header>

    <div class="main-grid">
      <!-- 左侧功能区 -->
      <div class="card">
        <div class="card-title">
          🔧 功能控制台
    </div>

        <!-- 认证部分 -->
        <div class="section">
          <div class="section-title">🔐 用户认证</div>
          <div class="form-group">
            <input id="base" placeholder="Base URL，例如 http://127.0.0.1:8080" value="http://localhost:8080" />
    </div>
          <div class="form-grid">
            <input id="username" placeholder="用户名" />
            <input id="password" placeholder="密码" type="password" />
    </div>
          <div class="form-group">
            <input id="nickname" placeholder="昵称(注册可选)" />
    </div>
          <div class="form-grid">
            <button class="btn btn-success" onclick="register()">📝 注册</button>
            <button class="btn" onclick="login()">🔑 登录</button>
    </div>
          <div class="form-row">
            <span class="tag">Token</span>
            <input id="token" placeholder="JWT token" />
    </div>
          <div class="form-row">
            <span class="tag">UserID</span>
            <input id="userId" placeholder="登录返回 userId" />
    </div>
          <div class="form-grid">
            <button class="btn btn-secondary" onclick="me()">👤 更新资料</button>
            <button class="btn btn-secondary" onclick="queryDevices()">📱 在线设备</button>
    </div>
          
          <!-- WebSocket连接 -->
          <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <div class="section-subtitle">🔌 WebSocket 连接</div>
            <div class="connection-status">
              <div class="status-indicator offline" id="wsStatus"></div>
              <span id="wsStatusText">未连接</span>
    </div>
            <div class="form-row">
              <input id="wsUrl" placeholder="WebSocket URL" value="ws://localhost:8080/ws" />
    </div>
            <div class="form-row">
              <input id="deviceId" placeholder="设备 ID（可自定义）" />
              <button class="btn" onclick="wsConnect()" id="wsBtn">🔌 连接</button>
    </div>
          </div>
        </div>

        <!-- 好友群组 -->
        <div class="section">
          <div class="section-title">👥 好友 & 群组</div>
          <div class="form-row">
            <input id="friendId" placeholder="好友 ID" />
            <button class="btn btn-success" onclick="addFriend()">➕ 加好友</button>
          </div>
          <div class="form-row">
            <input id="groupName" placeholder="群组名称" />
            <button class="btn btn-success" onclick="createGroup()">🏗️ 创建群</button>
          </div>
          <div class="form-row">
            <input id="groupId" placeholder="群组 ID" />
            <button class="btn" onclick="joinGroup()">🚪 加入群</button>
          </div>
        </div>

        <!-- 会话管理 -->
        <div class="section">
          <div class="section-title">💬 会话管理</div>
          <div class="form-grid">
            <button class="btn btn-secondary" onclick="listConvs()">📋 会话列表</button>
            <button class="btn btn-secondary" onclick="unreadSummary()">🔔 未读汇总</button>
          </div>
          <div class="form-row">
            <input id="convId" placeholder="会话 ID" />
            <button class="btn" onclick="markAllRead()">✅ 全部已读</button>
          </div>
          <div class="form-row">
            <input id="pinConvId" placeholder="会话 ID" />
            <button class="btn btn-secondary" onclick="pinConv(true)">📌 置顶</button>
            <button class="btn btn-secondary" onclick="pinConv(false)">📌 取消置顶</button>
          </div>
          <div class="form-row">
            <input id="muteConvId" placeholder="会话 ID" />
            <button class="btn btn-secondary" onclick="muteConv(true)">🔇 免打扰</button>
            <button class="btn btn-secondary" onclick="muteConv(false)">🔊 取消免打扰</button>
          </div>
          <div class="form-group">
            <input id="draftConvId" placeholder="草稿会话 ID" />
          </div>
          <div class="form-row">
      <input id="draftText" placeholder="草稿内容" />
            <button class="btn" onclick="setDraft()">💾 保存草稿</button>
    </div>
    </div>



        <!-- 消息发送 -->
        <div class="section">
          <div class="section-title">💌 消息发送</div>
          <div class="form-group">
            <input id="sendTo" placeholder="接收用户 ID（单聊）" />
    </div>
          <div class="form-row">
            <input id="sendGroupId" placeholder="群组 ID（群聊）" />
            <button class="btn btn-secondary" onclick="subscribeGroup()">👂 订阅群</button>
    </div>
          <div class="form-row">
      <select id="convType">
              <option value="c2c">👤 单聊 (C2C)</option>
              <option value="group">👥 群聊 (Group)</option>
      </select>
            <input id="clientMsgId" placeholder="客户端消息 ID" />
    </div>
          <div class="form-row">
      <input id="payloadText" placeholder="文本内容" />
            <span class="typing-indicator" id="peerTyping">对方正在输入...</span>
    </div>
          <button class="btn btn-success" onclick="wsSendText()" id="sendBtn" disabled>📤 发送消息</button>
        </div>

        <!-- 流式消息 -->
        <div class="section">
          <div class="section-title">🌊 流式消息</div>
          <div class="form-row">
      <input id="streamText" placeholder="流式消息初始内容" />
            <button class="btn" onclick="startStream()" id="startStreamBtn" disabled>🚀 开始流式</button>
    </div>
          <div class="form-row">
      <input id="streamDelta" placeholder="增量文本" />
            <button class="btn btn-secondary" onclick="sendChunk()" id="chunkBtn" disabled>📄 发送片段</button>
            <button class="btn btn-danger" onclick="endStream()" id="endStreamBtn" disabled>🛑 结束流式</button>
    </div>
          <div class="form-row">
            <span class="tag">StreamID</span>
            <input id="currentStreamId" placeholder="当前流 ID" readonly />
    </div>
        </div>
      </div>

      <!-- 中间功能区 -->
      <div class="card">
        <div class="card-title">
          🎯 高级功能
        </div>

        <!-- 音视频通话 -->
        <div class="section">
          <div class="section-title">📞 音视频通话</div>
          
          <!-- 设备选择 -->
          <div class="form-group">
            <div class="section-subtitle">🎛️ 设备选择</div>
            <div class="form-row">
              <select id="cameraSelect">
                <option value="">📹 选择摄像头</option>
              </select>
              <select id="microphoneSelect">
                <option value="">🎙️ 选择麦克风</option>
              </select>
              <button class="btn btn-small" onclick="refreshDevices()">🔄 刷新设备</button>
            </div>
          </div>

          <!-- 通话控制 -->
          <div class="form-group">
            <div class="section-subtitle">☎️ 通话控制</div>
            <div class="form-row">
              <input id="callTo" placeholder="通话对象 ID" />
      <select id="callType">
                <option value="audio">🎙️ 语音通话</option>
                <option value="video">📹 视频通话</option>
      </select>
    </div>
            <div class="form-grid">
              <button class="btn btn-success" onclick="startCall()" id="startCallBtn" disabled>📞 发起通话</button>
              <button class="btn" onclick="answerCall()" id="answerBtn" disabled>✅ 接听</button>
              <button class="btn btn-danger" onclick="rejectCall()" id="rejectBtn" disabled>❌ 拒接</button>
              <button class="btn btn-danger" onclick="endCall()" id="endBtn" disabled>📵 挂断</button>
    </div>
    </div>

          <!-- 媒体控制 -->
          <div class="form-group" id="mediaControls" style="display: none;">
            <div class="section-subtitle">🎛️ 媒体控制</div>
            <div class="form-grid">
              <button class="btn" onclick="toggleMute()" id="muteBtn">🎙️ 静音</button>
              <button class="btn" onclick="toggleVideo()" id="videoBtn">📹 关闭视频</button>
              <button class="btn" onclick="shareScreen()" id="screenBtn">🖥️ 共享屏幕</button>
              <button class="btn" onclick="testDevices()" id="testBtn">🧪 设备测试</button>
    </div>
    </div>
    
          <!-- 通话状态 -->
          <div class="form-group">
            <div class="section-subtitle">📊 通话状态</div>
            <div class="form-row">
              <span class="tag">CallID</span>
              <input id="currentCallId" placeholder="当前通话 ID" readonly />
            </div>
            <div class="form-row">
              <span class="tag">状态</span>
              <input id="callStatus" placeholder="通话状态" readonly />
            </div>
            <div class="form-row">
              <span class="tag">连接</span>
              <input id="connectionState" placeholder="连接状态" readonly />
            </div>
            <div class="form-row">
              <span class="tag">网络</span>
              <input id="networkQuality" placeholder="网络质量" readonly />
            </div>
          </div>

          <!-- 视频窗口 -->
          <div class="video-container">
            <div class="video-wrapper">
              <video id="localVideo" autoplay muted></video>
              <div class="video-label">本地</div>
              <div class="video-controls">
                <button class="video-control-btn" onclick="toggleLocalMute()" id="localMuteBtn">🎙️</button>
                <button class="video-control-btn" onclick="toggleLocalVideo()" id="localVideoBtn">📹</button>
              </div>
            </div>
            <div class="video-wrapper">
              <video id="remoteVideo" autoplay></video>
              <div class="video-label">远程</div>
              <div class="video-controls">
                <button class="video-control-btn" onclick="toggleFullscreen('remoteVideo')" id="fullscreenBtn">⛶</button>
              </div>
            </div>
          </div>

          <!-- 通话统计 -->
          <div class="form-group" id="callStats" style="display: none;">
            <div class="section-subtitle">📈 通话统计</div>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">音频码率</span>
                <span class="stat-value" id="audioBitrate">- kbps</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">视频码率</span>
                <span class="stat-value" id="videoBitrate">- kbps</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">丢包率</span>
                <span class="stat-value" id="packetLoss">- %</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">延迟</span>
                <span class="stat-value" id="latency">- ms</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 多媒体消息 -->
        <div class="section">
          <div class="section-title">🎨 多媒体消息</div>
          <div class="form-group">
      <select id="messageType">
              <option value="text">📝 文本消息</option>
              <option value="image">🖼️ 图片消息</option>
              <option value="voice">🎵 语音消息</option>
              <option value="video">🎬 视频消息</option>
              <option value="file">📁 文件消息</option>
              <option value="card">👤 名片消息</option>
              <option value="location">📍 位置消息</option>
      </select>
    </div>
          <div class="form-group" id="textMessage">
      <input id="msgText" placeholder="消息内容" />
    </div>
          <div class="form-group" id="fileMessage" style="display:none">
            <div class="file-upload">
      <input type="file" id="fileInput" />
              <div class="file-upload-label">
                📎 选择文件上传
    </div>
            </div>
            <button class="btn" onclick="uploadFile()" id="uploadBtn">⬆️ 上传文件</button>
          </div>
          <div id="cardMessage" style="display:none">
            <div class="form-grid-3">
      <input id="cardUserId" placeholder="名片用户ID" />
      <input id="cardNickname" placeholder="名片昵称" />
      <input id="cardAvatar" placeholder="名片头像URL" />
    </div>
          </div>
          <div id="locationMessage" style="display:none">
            <div class="form-grid-3">
      <input id="locLatitude" placeholder="纬度" type="number" step="any" />
      <input id="locLongitude" placeholder="经度" type="number" step="any" />
      <input id="locAddress" placeholder="地址描述" />
    </div>
          </div>
          <button class="btn btn-success" onclick="sendMessage()" id="sendMessageBtn" disabled>📤 发送消息</button>
    </div>
    
        <!-- 文件管理 -->
        <div class="section">
          <div class="section-title">📂 文件管理</div>
          <div class="form-grid">
            <button class="btn btn-secondary" onclick="listFiles()">📋 我的文件</button>
            <button class="btn btn-secondary" onclick="clearFileList()">🗑️ 清空列表</button>
    </div>
          <div id="fileList" class="file-list"></div>
        </div>

        <!-- 收藏管理 -->
        <div class="section">
          <div class="section-title">⭐ 收藏管理</div>
          <div class="form-row">
      <input id="favoriteTitle" placeholder="收藏标题" />
      <input id="favoriteTags" placeholder="标签（逗号分隔）" />
            <button class="btn btn-success" onclick="favoriteCustom()">⭐ 收藏</button>
    </div>
          <div class="form-grid">
      <input id="favoriteSearch" placeholder="搜索收藏" />
            <button class="btn btn-secondary" onclick="searchFavorites()">🔍 搜索</button>
    </div>
          <div class="form-grid">
            <button class="btn btn-secondary" onclick="listFavorites()">📋 我的收藏</button>
            <button class="btn btn-secondary" onclick="favoriteStats()">📊 收藏统计</button>
          </div>
          <div id="favoriteList" class="favorite-list"></div>
        </div>

        <!-- 群扩展功能 -->
        <div class="section">
          <div class="section-title">👥 群扩展功能</div>
          <div class="form-row">
            <input id="mentionUsers" placeholder="@成员 userId（逗号分隔）" />
            <button class="btn" onclick="sendMention()" id="mentionBtn" disabled>📢 @发送</button>
    </div>
          <div class="form-row">
      <input id="muteGroupId" placeholder="群ID" />
            <select id="muteOn">
              <option value="true">🔇 全员禁言 开</option>
              <option value="false">🔊 全员禁言 关</option>
            </select>
            <button class="btn" onclick="setGroupMute()">⚙️ 设置禁言</button>
    </div>
          <div class="form-group">
      <input id="noticeGroupId" placeholder="群ID" />
          </div>
          <div class="form-row">
      <input id="noticeTitle" placeholder="公告标题" />
      <input id="noticeContent" placeholder="公告内容" />
    </div>
          <div class="form-grid">
            <button class="btn btn-success" onclick="createNotice()">📢 发布公告</button>
            <button class="btn btn-secondary" onclick="listNotices()">📋 拉取公告</button>
          </div>
          <div id="noticeList" class="notice-list"></div>
        </div>

        <!-- OSS 直传 -->
        <div class="section">
          <div class="section-title">☁️ OSS 直传</div>
          <div class="form-row">
            <div class="file-upload">
      <input type="file" id="ossFile" />
              <div class="file-upload-label">
                ☁️ 选择 OSS 上传文件
    </div>
    </div>
            <input id="ossDir" placeholder="目录前缀（可选）" />
          </div>
          <button class="btn" onclick="ossDirectUpload()" id="ossUploadBtn">☁️ OSS 直传</button>
          <div class="form-row">
            <span class="tag">结果</span>
      <input id="ossUploadURL" placeholder="直传URL" readonly />
    </div>
        </div>
      </div>

      <!-- 右侧日志区 -->
      <div class="logs-grid">
        <div class="card">
          <div class="card-title">
            📊 系统日志
          </div>
          <div id="log" class="log-container"></div>
        </div>
        
        <div class="card">
          <div class="card-title">
            🔌 WebSocket 收发
          </div>
          <div id="wslog" class="log-container ws-log"></div>
        </div>
      </div>
    </div>
  </div>

<script>
let ws;
// 自动重连参数
let wsReconnectDelay = 1000; // 1s 起步
const wsReconnectMaxDelay = 15000; // 上限 15s
let wsReconnectTimer = null;

// WebRTC 增强变量
let availableDevices = { cameras: [], microphones: [] };
let currentStream = null;
let isAudioMuted = false;
let isVideoMuted = false;
let isScreenSharing = false;
let callStatsInterval = null;

function log(msg){ const el=document.getElementById('log'); el.textContent += `\n${new Date().toLocaleTimeString()} ${msg}`; el.scrollTop=el.scrollHeight; }
function wslog(msg){ const el=document.getElementById('wslog'); el.textContent += `\n${new Date().toLocaleTimeString()} ${msg}`; el.scrollTop=el.scrollHeight; }

function base(){ return document.getElementById('base').value || location.origin }
function authHeader(){ const t=document.getElementById('token').value; return t? { 'Authorization': 'Bearer '+t } : {} }
async function post(path, body){ const r = await fetch(base()+path, {method:'POST', headers:{'Content-Type':'application/json',...authHeader()}, body:JSON.stringify(body||{})}); const j= await r.json().catch(()=>({})); log(`[POST] ${path} → ${r.status} ${JSON.stringify(j)}`); return j }
async function put(path, body){ const r = await fetch(base()+path, {method:'PUT', headers:{'Content-Type':'application/json',...authHeader()}, body:JSON.stringify(body||{})}); log(`[PUT] ${path} → ${r.status}`) }
async function del(path){ const r = await fetch(base()+path, {method:'DELETE', headers:{...authHeader()}}); log(`[DELETE] ${path} → ${r.status}`) }
async function get(path){ const r = await fetch(base()+path, {headers:{...authHeader()}}); const j= await r.json().catch(()=>({})); log(`[GET] ${path} → ${r.status} ${JSON.stringify(j)}`); return j }

async function register(){ const j=await post('/api/register',{username:val('username'),password:val('password'),nickname:val('nickname')}); }
async function login(){ 
  const j=await post('/api/login',{username:val('username'),password:val('password')}); 
  if(j.token){ 
    setVal('token', j.token); 
    setVal('userId', j.userId);
    log('✅ 登录成功！请点击下方"🔌 连接"按钮连接WebSocket');
    
    // 高亮WebSocket连接按钮
    const wsBtn = document.getElementById('wsBtn');
    if (wsBtn) {
      wsBtn.style.animation = 'pulse 2s infinite';
      setTimeout(() => { 
        if (wsBtn.style.animation) wsBtn.style.animation = ''; 
      }, 6000);
    }
  } 
}
async function me(){ await put('/api/users/me',{nickname:val('nickname'),avatarUrl:''}) }
async function addFriend(){ await post('/api/friends',{friendID:val('friendId'),remark:''}) }
async function createGroup(){ const j=await post('/api/groups',{name:val('groupName')}); if(j.groupId) setVal('groupId', j.groupId) }
async function joinGroup(){ await post(`/api/groups/${val('groupId')}/join`) }
async function listConvs(){ await get('/api/conversations?limit=50') }
async function unreadSummary(){ await get('/api/unread/summary') }
async function markAllRead(){ await post('/api/unread/mark_all_read') }
async function pinConv(on){ await post(`/api/conversations/${val('pinConvId')}/pin`,{pinned:on}) }
async function muteConv(on){ await post(`/api/conversations/${val('muteConvId')}/mute`,{muted:on}) }
async function setDraft(){ await post(`/api/conversations/${val('draftConvId')}/draft`,{draft:val('draftText')}) }
async function queryDevices(){ await get('/api/users/me/devices') }

function updateConnectionStatus(connected) {
  const statusEl = document.getElementById('wsStatus');
  const textEl = document.getElementById('wsStatusText');
  if (connected) {
    statusEl.classList.remove('offline');
    textEl.textContent = '已连接';
  } else {
    statusEl.classList.add('offline');
    textEl.textContent = '未连接';
  }
}

function wsConnect(){
  // 检查是否已登录
  const token = val('token');
  if (!token) {
    log('❌ 请先登录再连接WebSocket');
    return;
  }
  
  // 关闭旧连接并清理重连计时器
  if(ws){ try{ ws.close() }catch{} ws=undefined }
  if(wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer=null }
  
  const url=(document.getElementById('wsUrl').value||`${location.origin.replace('http','ws')}/ws`)+`?token=${token}&deviceId=${encodeURIComponent(val('deviceId')||('web-'+Date.now()))}`;
  
  log('🔌 正在连接WebSocket...');
  ws=new WebSocket(url);
  
  ws.onopen=()=>{ 
    wslog('✅ WebSocket连接成功'); 
    log('🎉 WebSocket已连接，现在可以收发消息了！');
    enableSend(true); 
    wsReconnectDelay=1000; 
    if(wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer=null } 
    updateConnectionStatus(true); 
  };
  
  ws.onclose=()=>{ 
    wslog('❌ WebSocket连接已关闭'); 
    log('🔌 WebSocket连接已断开');
    enableSend(false); 
    scheduleWsReconnect(); 
    updateConnectionStatus(false); 
  };
  
  ws.onerror=(e)=>{ 
    wslog('❌ WebSocket连接错误'); 
    log('❌ WebSocket连接失败，请检查网络和服务器状态');
    scheduleWsReconnect(); 
    updateConnectionStatus(false); 
  };
  
  ws.onmessage=(ev)=>{ wslog('← '+ev.data); handleWSMessage(ev.data) };
}

function scheduleWsReconnect(){
  if(wsReconnectTimer) return;
  const delay = wsReconnectDelay;
  wslog(`WS 将在 ${delay}ms 后重连...`);
  wsReconnectTimer = setTimeout(()=>{
    wsReconnectTimer = null;
    wsConnect();
    wsReconnectDelay = Math.min(wsReconnectDelay * 2, wsReconnectMaxDelay);
  }, delay);
}

function enableStreamBtns(streaming){ document.getElementById('chunkBtn').disabled=!streaming; document.getElementById('endStreamBtn').disabled=!streaming; }

let peerConnection, localStream, remoteStream;
let currentCall = null;
let iceServers = [];
let pendingCandidates = [];

// WebRTC 初始化
async function initWebRTC() {
  try {
    const resp = await get('/api/webrtc/ice-servers');
    if (resp.iceServers) { iceServers = resp.iceServers; }
  } catch (e) { console.log('ICE servers not available:', e); }
}

// 创建 PeerConnection
function createPeerConnection() {
  const config = { iceServers: iceServers.length > 0 ? iceServers : [{ urls: 'stun:stun.l.google.com:19302' }] };
  peerConnection = new RTCPeerConnection(config);
  
  peerConnection.onicecandidate = (event) => {
    if (event.candidate && currentCall) {
      const c = event.candidate.toJSON ? event.candidate.toJSON() : event.candidate;
      const msg = { action: 'webrtc_signaling', data: { callId: currentCall.id, type: 'candidate', candidate: c, to: getOtherUserId() } };
      ws.send(JSON.stringify(msg));
      wslog('→ ICE Candidate');
    }
  };
  
  peerConnection.ontrack = (event) => {
    wslog('← 收到远程流');
    const remoteVideo = document.getElementById('remoteVideo');
    if (remoteVideo) { remoteVideo.srcObject = event.streams[0]; }
  };
  
  // 连接状态监控
  peerConnection.onconnectionstatechange = () => {
    const state = peerConnection.connectionState;
    wslog(`连接状态变更: ${state}`);
    document.getElementById('connectionState').value = state;
    
    if (state === 'connected') {
      wslog('🎉 WebRTC连接建立成功');
    } else if (state === 'failed' || state === 'disconnected') {
      wslog('❌ WebRTC连接失败或断开');
    }
  };
  
  // ICE连接状态监控
  peerConnection.oniceconnectionstatechange = () => {
    wslog(`ICE连接状态: ${peerConnection.iceConnectionState}`);
  };
  
  return peerConnection;
}

// 处理WebRTC信令
async function handleSignalingMessage(data) {
  try {
    if (!peerConnection && data.type === 'offer') {
      createPeerConnection();
      if (localStream) {
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      }
    }

    switch (data.type) {
      case 'offer':
        await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));
        // 设置远端后，把缓存的候选补上
        for (const c of pendingCandidates) {
          try { await peerConnection.addIceCandidate(new RTCIceCandidate(c)); } catch {}
        }
        pendingCandidates = [];
        // 生成并发送 answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        ws.send(JSON.stringify({ action: 'webrtc_signaling', data: { callId: currentCall.id, type: 'answer', sdp: answer.sdp, to: getOtherUserId() } }));
        wslog('→ 发送Answer');
        break;
      case 'answer':
        await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
        break;
      case 'candidate':
        if (!peerConnection || !peerConnection.remoteDescription) {
          pendingCandidates.push(data.candidate);
        } else {
          try { await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch (e) { wslog('添加ICE失败: '+e.message); }
        }
        break;
    }
  } catch (e) {
    wslog('处理信令失败: ' + e.message);
  }
}

// 获取本地媒体流
async function getLocalStream(video = false) {
  try {
    // 获取选择的设备ID
    const cameraId = document.getElementById('cameraSelect').value;
    const micId = document.getElementById('microphoneSelect').value;
    
    const constraints = { 
      audio: micId ? { deviceId: micId } : true,
      video: video ? (cameraId ? { deviceId: cameraId } : true) : false
    };
    
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = localStream; // 保存引用
    
    const localVideo = document.getElementById('localVideo');
    if (localVideo) { localVideo.srcObject = localStream; }
    
    wslog(`媒体流获取成功: 音频=${!!localStream.getAudioTracks().length}, 视频=${!!localStream.getVideoTracks().length}`);
    return localStream;
  } catch (e) { 
    wslog('获取媒体流失败: ' + e.message); 
    throw e; 
  }
}

// 发起通话
async function startCall() {
  const to = val('callTo'); const type = val('callType');
  if (!to) { wslog('ERROR: 请填写通话对象'); return; }
  
  try {
    await getLocalStream(type === 'video');
    const msg = { action: 'call_start', data: { to, type } };
    ws.send(JSON.stringify(msg)); wslog('→ 发起通话: ' + to);
  } catch (e) { wslog('ERROR: 发起通话失败: ' + e.message); }
}

// 接听通话
async function answerCall() {
  if (!currentCall) { wslog('ERROR: 无通话可接听'); return; }
  
  try {
    await getLocalStream(currentCall.type === 'video');
    createPeerConnection();
    
    // 添加本地流
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    
    const msg = { action: 'call_answer', data: { callId: currentCall.id } };
    ws.send(JSON.stringify(msg)); wslog('→ 接听通话');
  } catch (e) { wslog('ERROR: 接听失败: ' + e.message); }
}

// 拒接通话
function rejectCall() {
  if (!currentCall) return;
  const msg = { action: 'call_reject', data: { callId: currentCall.id } };
  ws.send(JSON.stringify(msg)); wslog('→ 拒接通话');
}

// 挂断通话
function endCall() {
  if (!currentCall) return;
  const msg = { action: 'call_end', data: { callId: currentCall.id } };
  ws.send(JSON.stringify(msg)); wslog('→ 挂断通话');
  cleanupCall();
}

// 清理通话资源
function cleanupCall() {
  if (peerConnection) { peerConnection.close(); peerConnection = null; }
  if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
  const localVideo = document.getElementById('localVideo'); if (localVideo) localVideo.srcObject = null;
  const remoteVideo = document.getElementById('remoteVideo'); if (remoteVideo) remoteVideo.srcObject = null;
  currentCall = null; setVal('currentCallId', ''); setVal('callStatus', ''); updateCallButtons();
}

// 获取对方用户ID
function getOtherUserId() {
  if (!currentCall) return '';
  return currentCall.fromUserId === val('userId') ? currentCall.toUserId : currentCall.fromUserId;
}

// 更新通话按钮状态
function updateCallButtons() {
  const hasCall = !!currentCall;
  const isIncoming = hasCall && currentCall.fromUserId !== val('userId') && currentCall.status === 'calling';
  document.getElementById('startCallBtn').disabled = hasCall;
  document.getElementById('answerBtn').disabled = !isIncoming;
  document.getElementById('rejectBtn').disabled = !isIncoming;
  document.getElementById('endBtn').disabled = !hasCall;
  
  // 显示/隐藏媒体控制和统计
  const mediaControls = document.getElementById('mediaControls');
  const callStats = document.getElementById('callStats');
  if (hasCall) {
    mediaControls.style.display = 'block';
    callStats.style.display = 'block';
    startCallStatsMonitoring();
  } else {
    mediaControls.style.display = 'none';
    callStats.style.display = 'none';
    stopCallStatsMonitoring();
  }
}

// ====== 设备管理 ======

// 刷新设备列表
async function refreshDevices() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    availableDevices.cameras = devices.filter(d => d.kind === 'videoinput');
    availableDevices.microphones = devices.filter(d => d.kind === 'audioinput');
    
    updateDeviceSelectors();
    wslog(`设备刷新: ${availableDevices.cameras.length}个摄像头, ${availableDevices.microphones.length}个麦克风`);
  } catch (e) {
    wslog('设备枚举失败: ' + e.message);
  }
}

// 更新设备选择器
function updateDeviceSelectors() {
  const cameraSelect = document.getElementById('cameraSelect');
  const micSelect = document.getElementById('microphoneSelect');
  
  // 清空现有选项
  cameraSelect.innerHTML = '<option value="">📹 选择摄像头</option>';
  micSelect.innerHTML = '<option value="">🎙️ 选择麦克风</option>';
  
  // 添加摄像头选项
  availableDevices.cameras.forEach(device => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `摄像头 ${device.deviceId.slice(0, 8)}`;
    cameraSelect.appendChild(option);
  });
  
  // 添加麦克风选项
  availableDevices.microphones.forEach(device => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `麦克风 ${device.deviceId.slice(0, 8)}`;
    micSelect.appendChild(option);
  });
}

// ====== 媒体控制 ======

// 切换静音
function toggleMute() {
  if (!localStream) return;
  
  const audioTrack = localStream.getAudioTracks()[0];
  if (audioTrack) {
    isAudioMuted = !isAudioMuted;
    audioTrack.enabled = !isAudioMuted;
    
    const btn = document.getElementById('muteBtn');
    const localBtn = document.getElementById('localMuteBtn');
    
    if (isAudioMuted) {
      btn.textContent = '🔇 取消静音';
      btn.classList.add('active');
      localBtn.classList.add('active');
    } else {
      btn.textContent = '🎙️ 静音';
      btn.classList.remove('active');
      localBtn.classList.remove('active');
    }
    
    wslog(isAudioMuted ? '已静音' : '已取消静音');
  }
}

// 切换视频
function toggleVideo() {
  if (!localStream) return;
  
  const videoTrack = localStream.getVideoTracks()[0];
  if (videoTrack) {
    isVideoMuted = !isVideoMuted;
    videoTrack.enabled = !isVideoMuted;
    
    const btn = document.getElementById('videoBtn');
    const localBtn = document.getElementById('localVideoBtn');
    
    if (isVideoMuted) {
      btn.textContent = '📹 开启视频';
      btn.classList.add('active');
      localBtn.classList.add('active');
    } else {
      btn.textContent = '📹 关闭视频';
      btn.classList.remove('active');
      localBtn.classList.remove('active');
    }
    
    wslog(isVideoMuted ? '已关闭视频' : '已开启视频');
  }
}

// 本地静音控制
function toggleLocalMute() {
  toggleMute();
}

// 本地视频控制
function toggleLocalVideo() {
  toggleVideo();
}

// 屏幕共享
async function shareScreen() {
  try {
    if (isScreenSharing) {
      // 停止屏幕共享，恢复摄像头
      const cameraId = document.getElementById('cameraSelect').value;
      const constraints = {
        video: cameraId ? { deviceId: cameraId } : true,
        audio: { deviceId: document.getElementById('microphoneSelect').value || undefined }
      };
      
      const newStream = await navigator.mediaDevices.getUserMedia(constraints);
      replaceLocalStream(newStream);
      
      document.getElementById('screenBtn').textContent = '🖥️ 共享屏幕';
      isScreenSharing = false;
      wslog('已停止屏幕共享');
    } else {
      // 开始屏幕共享
      const screenStream = await navigator.mediaDevices.getDisplayMedia({
        video: true,
        audio: true
      });
      
      replaceLocalStream(screenStream);
      
      document.getElementById('screenBtn').textContent = '📹 摄像头';
      isScreenSharing = true;
      wslog('已开始屏幕共享');
      
      // 监听用户停止共享
      screenStream.getVideoTracks()[0].onended = () => {
        shareScreen(); // 自动切回摄像头
      };
    }
  } catch (e) {
    wslog('屏幕共享失败: ' + e.message);
  }
}

// 替换本地流
function replaceLocalStream(newStream) {
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }
  
  localStream = newStream;
  const localVideo = document.getElementById('localVideo');
  if (localVideo) localVideo.srcObject = newStream;
  
  // 如果在通话中，更新PeerConnection
  if (peerConnection && currentCall) {
    const sender = peerConnection.getSenders().find(s => 
      s.track && s.track.kind === 'video'
    );
    if (sender) {
      sender.replaceTrack(newStream.getVideoTracks()[0]);
    }
  }
}

// 设备测试
async function testDevices() {
  try {
    const cameraId = document.getElementById('cameraSelect').value;
    const micId = document.getElementById('microphoneSelect').value;
    
    const constraints = {
      video: cameraId ? { deviceId: cameraId } : true,
      audio: micId ? { deviceId: micId } : true
    };
    
    const testStream = await navigator.mediaDevices.getUserMedia(constraints);
    const localVideo = document.getElementById('localVideo');
    
    if (localVideo) {
      localVideo.srcObject = testStream;
      wslog('设备测试成功');
      
      // 5秒后停止测试
      setTimeout(() => {
        testStream.getTracks().forEach(track => track.stop());
        localVideo.srcObject = null;
        wslog('设备测试结束');
      }, 5000);
    }
  } catch (e) {
    wslog('设备测试失败: ' + e.message);
  }
}

// 全屏切换
function toggleFullscreen(videoId) {
  const video = document.getElementById(videoId);
  if (!video) return;
  
  if (document.fullscreenElement) {
    document.exitFullscreen();
  } else {
    video.requestFullscreen().catch(e => {
      wslog('全屏失败: ' + e.message);
    });
  }
}

// ====== 通话统计 ======

// 开始通话统计监控
function startCallStatsMonitoring() {
  if (callStatsInterval) return;
  
  callStatsInterval = setInterval(async () => {
    if (!peerConnection) return;
    
    try {
      const stats = await peerConnection.getStats();
      updateCallStats(stats);
    } catch (e) {
      console.error('获取统计失败:', e);
    }
  }, 2000);
}

// 停止通话统计监控
function stopCallStatsMonitoring() {
  if (callStatsInterval) {
    clearInterval(callStatsInterval);
    callStatsInterval = null;
  }
  
  // 清空统计显示
  document.getElementById('audioBitrate').textContent = '- kbps';
  document.getElementById('videoBitrate').textContent = '- kbps';
  document.getElementById('packetLoss').textContent = '- %';
  document.getElementById('latency').textContent = '- ms';
}

// 更新通话统计显示
function updateCallStats(stats) {
  let audioBitrate = 0, videoBitrate = 0, packetLoss = 0, latency = 0;
  
  stats.forEach(report => {
    if (report.type === 'outbound-rtp') {
      if (report.kind === 'audio' && report.bytesSent) {
        audioBitrate = Math.round((report.bytesSent * 8) / 1000); // kbps
      } else if (report.kind === 'video' && report.bytesSent) {
        videoBitrate = Math.round((report.bytesSent * 8) / 1000); // kbps
      }
    } else if (report.type === 'inbound-rtp') {
      if (report.packetsLost && report.packetsReceived) {
        packetLoss = Math.round((report.packetsLost / (report.packetsLost + report.packetsReceived)) * 100);
      }
    } else if (report.type === 'candidate-pair' && report.state === 'succeeded') {
      if (report.currentRoundTripTime) {
        latency = Math.round(report.currentRoundTripTime * 1000); // ms
      }
    }
  });
  
  document.getElementById('audioBitrate').textContent = audioBitrate + ' kbps';
  document.getElementById('videoBitrate').textContent = videoBitrate + ' kbps';
  document.getElementById('packetLoss').textContent = packetLoss + ' %';
  document.getElementById('latency').textContent = latency + ' ms';
  
  // 更新连接状态
  document.getElementById('connectionState').value = peerConnection.connectionState || '-';
  
  // 简单的网络质量评估
  let quality = '优秀';
  if (latency > 200 || packetLoss > 5) quality = '较差';
  else if (latency > 100 || packetLoss > 2) quality = '一般';
  else if (latency > 50 || packetLoss > 1) quality = '良好';
  
  document.getElementById('networkQuality').value = quality;
}

function val(id){ return document.getElementById(id).value }
function setVal(id,v){ document.getElementById(id).value=v }
function enableSend(on){ 
  document.getElementById('sendBtn').disabled=!on; 
  document.getElementById('startStreamBtn').disabled=!on; 
  document.getElementById('startCallBtn').disabled=!on || !!currentCall;
  document.getElementById('sendMessageBtn').disabled=!on;
  document.getElementById('mentionBtn').disabled=!on;
  document.getElementById('wsBtn').textContent= on? '🔄 重连' : '🔌 连接';
  if (on) initWebRTC();
}

async function sendMention(){
  const convId = val('convId'); const convType = 'group'; const groupId = val('groupId');
  if (!groupId || !convId) { wslog('ERROR: 请先填写 groupId/convId'); return; }
  const mentions = val('mentionUsers').split(',').map(s=>s.trim()).filter(Boolean);
  const payload = { text: val('msgText'), mentions };
  const msg = { action: 'send', data: { convId, convType, groupId, type: 'text', clientMsgId: Date.now().toString(), payload } };
  ws.send(JSON.stringify(msg)); wslog('→ @群消息: ' + JSON.stringify(msg));
}

// 消息类型切换
document.getElementById('messageType').addEventListener('change', function() {
  const type = this.value;
  document.getElementById('textMessage').style.display = type === 'text' ? 'block' : 'none';
  document.getElementById('fileMessage').style.display = ['image', 'voice', 'video', 'file'].includes(type) ? 'block' : 'none';
  document.getElementById('cardMessage').style.display = type === 'card' ? 'block' : 'none';
  document.getElementById('locationMessage').style.display = type === 'location' ? 'block' : 'none';
});

// 发送多媒体消息
async function sendMessage() {
  const type = val('messageType');
  const convId = val('convId'); const convType = val('convType'); const to = val('sendTo'); const groupId = val('sendGroupId');
  
  if (!convId) { wslog('ERROR: 请填写会话ID'); return; }
  
  let payload = {};
  
  switch (type) {
    case 'text':
      payload = { text: val('msgText') };
      break;
    case 'card':
      payload = { userId: val('cardUserId'), nickname: val('cardNickname'), avatar: val('cardAvatar') };
      break;
    case 'location':
      payload = { latitude: parseFloat(val('locLatitude')), longitude: parseFloat(val('locLongitude')), address: val('locAddress') };
      break;
    case 'image':
    case 'voice':
    case 'video':
    case 'file':
      // 需要先上传文件
      wslog('请先上传文件，然后使用返回的URL构造消息');
      return;
  }
  
  const msg = { action: 'send', data: { convId, convType, to, groupId, type, clientMsgId: Date.now().toString(), payload } };
  ws.send(JSON.stringify(msg)); wslog('→ 发送消息: ' + JSON.stringify(msg));
}

// Typing：输入联动上报
yetTypingTimer = null;
let typingState = false;
const msgInput = document.getElementById('msgText');
if (msgInput) {
  msgInput.addEventListener('input', () => {
    // 触发开始输入
    if (!typingState) {
      typingState = true;
      sendTyping(true);
    }
    // 停止输入（500ms 无输入）
    clearTimeout(yetTypingTimer);
    yetTypingTimer = setTimeout(() => { typingState = false; sendTyping(false); }, 500);
  });
}

function sendTyping(isTyping) {
  if (!ws || ws.readyState !== 1) return;
  const convId = val('convId'); if (!convId) return;
  const payload = {
    convId: convId,
    convType: val('convType'),
    to: val('sendTo'),
    groupId: val('sendGroupId'),
    typing: !!isTyping,
  };
  const msg = { action: 'typing', data: payload };
  ws.send(JSON.stringify(msg));
}

// 显示对端输入中
defaultTypingHideTimer = null;
function handleTypingIndicator(data) {
  const convId = val('convId');
  if (!convId || data.convId !== convId) return;
  const el = document.getElementById('peerTyping');
  if (!el) return;
  if (data.typing) {
    el.style.display = 'inline-block';
    clearTimeout(defaultTypingHideTimer);
    defaultTypingHideTimer = setTimeout(() => { el.style.display = 'none'; }, 1500);
  } else {
    el.style.display = 'none';
  }
}

// 上传文件
async function uploadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) { wslog('ERROR: 请选择文件'); return; }
  
  const formData = new FormData(); formData.append('file', file);
  
  try {
    const resp = await fetch('/api/files/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + val('token') }, body: formData });
    const result = await resp.json();
    if (resp.ok) {
      wslog('✓ 文件上传成功: ' + result.url);
      
      // 自动构造消息载荷
      const type = val('messageType');
      let payload = { url: result.url, name: result.fileName, size: result.fileSize, mimeType: result.mimeType };
      
      if (type === 'image') {
        // 可以添加图片尺寸等信息
        payload.format = result.fileName.split('.').pop().toLowerCase();
      } else if (type === 'voice') {
        payload.duration = 0; // 需要前端检测音频时长
        payload.format = result.fileName.split('.').pop().toLowerCase();
      } else if (type === 'video') {
        payload.duration = 0; // 需要前端检测视频时长
        payload.format = result.fileName.split('.').pop().toLowerCase();
      }
      
      // 显示载荷供用户查看/修改
      setVal('msgText', JSON.stringify(payload));
    } else {
      wslog('ERROR: 上传失败: ' + result.error);
    }
  } catch (e) {
    wslog('ERROR: 上传异常: ' + e.message);
  }
}

// 文件管理
async function listFiles() {
  try {
    const resp = await get('/api/files');
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    if (resp.files && resp.files.length > 0) {
    resp.files.forEach(file => {
      const div = document.createElement('div');
        div.className = 'file-item';
      div.innerHTML = `
          <div>
            <strong>${file.fileName}</strong><br>
            <small>${(file.fileSize/1024).toFixed(1)}KB - ${file.url}</small>
          </div>
          <button class="btn btn-small btn-danger" onclick="deleteFile('${file.id}')">🗑️</button>
      `;
      fileList.appendChild(div);
    });
    } else {
      fileList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">暂无文件</div>';
    }
  } catch (e) { wslog('ERROR: 获取文件列表失败: ' + e.message); }
}

async function deleteFile(fileId) {
  try {
    await fetch(`/api/files/${fileId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + val('token') } });
    wslog('✓ 文件删除成功'); listFiles();
  } catch (e) { wslog('ERROR: 删除文件失败: ' + e.message); }
}

function clearFileList() { document.getElementById('fileList').innerHTML = ''; }

// 收藏管理
async function favoriteCustom() {
  const title = val('favoriteTitle'); const tags = val('favoriteTags').split(',').map(s => s.trim()).filter(s => s);
  const convId = val('convId'); const content = { text: val('msgText'), timestamp: new Date().toISOString() };
  
  if (!title || !convId) { wslog('ERROR: 请填写收藏标题和会话ID'); return; }
  
  try {
    const resp = await post('/api/favorites/custom', { convId, title, content, tags });
    wslog('✓ 收藏成功: ' + resp.id);
  } catch (e) { wslog('ERROR: 收藏失败: ' + e.message); }
}

async function listFavorites() {
  try {
    const resp = await get('/api/favorites');
    const favoriteList = document.getElementById('favoriteList');
    favoriteList.innerHTML = '';
    
    if (resp.favorites && resp.favorites.length > 0) {
    resp.favorites.forEach(fav => {
      const div = document.createElement('div');
        div.className = 'favorite-item';
      div.innerHTML = `
          <div>
            <strong>${fav.title}</strong> [${fav.type}]<br>
            <small>标签: ${fav.tags || '无'}</small>
          </div>
          <button class="btn btn-small btn-danger" onclick="deleteFavorite('${fav.id}')">🗑️</button>
      `;
      favoriteList.appendChild(div);
    });
    } else {
      favoriteList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">暂无收藏</div>';
    }
  } catch (e) { wslog('ERROR: 获取收藏失败: ' + e.message); }
}

async function searchFavorites() {
  const keyword = val('favoriteSearch');
  if (!keyword) { wslog('ERROR: 请输入搜索关键词'); return; }
  
  try {
    const resp = await get(`/api/favorites/search?keyword=${encodeURIComponent(keyword)}`);
    const favoriteList = document.getElementById('favoriteList');
    favoriteList.innerHTML = `<div style="font-weight:600;margin-bottom:12px;">搜索结果 (${resp.favorites?.length || 0})</div>`;
    
    if (resp.favorites && resp.favorites.length > 0) {
    resp.favorites.forEach(fav => {
      const div = document.createElement('div');
        div.className = 'favorite-item';
        div.innerHTML = `
          <div>
            <strong>${fav.title}</strong> [${fav.type}]<br>
            <small>标签: ${fav.tags || '无'}</small>
          </div>
        `;
      favoriteList.appendChild(div);
    });
    } else {
      favoriteList.innerHTML += '<div style="text-align:center;color:var(--text-muted);padding:20px;">未找到相关收藏</div>';
    }
  } catch (e) { wslog('ERROR: 搜索收藏失败: ' + e.message); }
}

async function deleteFavorite(favoriteId) {
  try {
    await fetch(`/api/favorites/${favoriteId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + val('token') } });
    wslog('✓ 收藏删除成功'); listFavorites();
  } catch (e) { wslog('ERROR: 删除收藏失败: ' + e.message); }
}

async function favoriteStats() {
  try {
    const stats = await get('/api/favorites/stats');
    wslog('📊 收藏统计: ' + JSON.stringify(stats));
  } catch (e) { wslog('ERROR: 获取收藏统计失败: ' + e.message); }
}

// 处理提及消息
function handleMention(data) {
  const convId = val('convId');
  if (!convId || data.convId !== convId) return;
  const mentionUsers = val('mentionUsers').split(',').map(s => s.trim()).filter(s => s);
  const mentionText = val('msgText');
  const mentionRegex = new RegExp('@(' + mentionUsers.join('|') + ')', 'g');
  const newText = mentionText.replace(mentionRegex, (match) => {
    const userId = match.substring(1); // 移除 @ 符号
    return `<span style="color: #57606a; font-weight: bold;">@${userId}</span>`;
  });
  setVal('msgText', newText);
  document.getElementById('mentionBtn').disabled = mentionUsers.length === 0;
}

// 处理群公告
async function createNotice() {
  const groupId = val('noticeGroupId');
  const title = val('noticeTitle');
  const content = val('noticeContent');

  if (!groupId || !title || !content) {
    wslog('ERROR: 请填写群ID、标题和内容');
    return;
  }

  try {
    const resp = await post(`/api/groups/${groupId}/notices`, { title, content });
    wslog('✓ 公告发布成功: ' + resp.id);
    listNotices(); // 刷新公告列表
  } catch (e) { wslog('ERROR: 发布公告失败: ' + e.message); }
}

async function listNotices() {
  const groupId = val('noticeGroupId');
  if (!groupId) {
    wslog('ERROR: 请先选择群ID');
    return;
  }

  try {
    const resp = await get(`/api/groups/${groupId}/notices`);
    const noticeList = document.getElementById('noticeList');
    noticeList.innerHTML = `<div style="font-weight:600;margin-bottom:12px;">群公告 (${resp.list?.length || 0})</div>`;
    
    if (resp.list && resp.list.length > 0) {
    resp.list.forEach(notice => {
        const div = document.createElement('div');
        div.className = 'notice-item';
        div.innerHTML = `
          <div>
            <strong>${notice.title}</strong><br>
            <small>${notice.content}</small>
          </div>
        `;
        noticeList.appendChild(div);
      });
    } else {
      noticeList.innerHTML += '<div style="text-align:center;color:var(--text-muted);padding:20px;">暂无公告</div>';
    }
  } catch (e) { wslog('ERROR: 获取公告失败: ' + e.message); }
}

async function setGroupMute() {
  const groupId = val('muteGroupId');
  const muted = val('muteOn') === 'true';

  if (!groupId) {
    wslog('ERROR: 请先选择群ID');
    return;
  }

  try {
    await post(`/api/groups/${groupId}/mute`, { muted });
    wslog(`✓ 群 ${groupId} 全员禁言 ${muted ? '开启' : '关闭'}`);
  } catch (e) { wslog('ERROR: 设置群禁言失败: ' + e.message); }
}

// OSS 直传
async function ossDirectUpload() {
  const fileInput = document.getElementById('ossFile');
  const ossDirInput = document.getElementById('ossDir');
  const ossUploadURLInput = document.getElementById('ossUploadURL');

  if (!fileInput.files[0]) { wslog('ERROR: 请选择要上传的文件'); return; }
  const file = fileInput.files[0];
  const userDir = (ossDirInput.value || '').replace(/^\/+|\/+$/g, '');

  try {
    // 1) 向后端申请 policy（POST 表单：dir 可选）
    const policyForm = new FormData();
    if (userDir) policyForm.append('dir', userDir);
    const policyResp = await fetch('/api/files/oss/policy', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + val('token') },
      body: policyForm
    });
    const p = await policyResp.json();
    if (!policyResp.ok) { wslog('ERROR: 获取 OSS policy 失败: ' + (p.error || '')); return; }

    const host = p.host;            // https://bucket.endpoint
    const keyPrefix = p.dir;        // 后端返回的前缀，已包含日期，如 uploads/2025/08/08/
    const accessKeyId = p.accessKeyId;
    const policy = p.policy;
    const signature = p.signature;

    // 2) 生成 object key（前缀 + 随机名）
    const ext = (file.name.lastIndexOf('.') >= 0) ? file.name.substring(file.name.lastIndexOf('.')) : '';
    const rand = (Date.now().toString(36) + Math.random().toString(36).slice(2,8)).toLowerCase();
    const objectKey = keyPrefix + rand + ext;

    // 3) 构造直传表单并上传到 OSS
    const formData = new FormData();
    formData.append('key', objectKey);
    formData.append('policy', policy);
    formData.append('OSSAccessKeyId', accessKeyId);
    formData.append('success_action_status', '200');
    formData.append('signature', signature);
    formData.append('file', file);

    const uploadResp = await fetch(host, { method: 'POST', body: formData });
    if (uploadResp.status !== 200) {
      const errText = await uploadResp.text();
      wslog('ERROR: OSS 直传失败: ' + uploadResp.status + ' ' + errText);
      return;
    }

    const fileURL = host.replace(/\/$/, '') + '/' + objectKey;
    ossUploadURLInput.value = fileURL;
    wslog('✓ OSS 直传成功: ' + fileURL);

    // 4) 通知后端入库（可选）
    const confirmResp = await post('/api/files/oss/confirm', { key: objectKey, size: file.size, mimeType: file.type });
    if (confirmResp && confirmResp.id) {
      wslog('✓ 后端已入库: ' + confirmResp.id);
    }

    // 5) 将文件消息载荷写入文本框，便于直接发送
    const type = val('messageType');
    let payload = { url: fileURL, name: file.name, size: file.size, mimeType: file.type };
    setVal('msgText', JSON.stringify(payload));
  } catch (e) {
    wslog('ERROR: OSS 直传异常: ' + e.message);
  }
}

// 单聊 / 群聊 会话生成
function generateConvId() {
  const convType = document.getElementById('convType').value;
  const to = document.getElementById('sendTo').value;
  const groupId = document.getElementById('sendGroupId').value;
  const convIdInput = document.getElementById('convId');

  if (convType === 'c2c') {
    if (!to) { wslog('ERROR: 请先填写对方用户ID'); return; }
    convIdInput.value = `c2c-${to}-${Date.now()}`;
  } else if (convType === 'group') {
    if (!groupId) { wslog('ERROR: 请先填写群ID'); return; }
    convIdInput.value = `group-${groupId}-${Date.now()}`;
  }
  wslog('✓ 会话ID生成成功: ' + convIdInput.value);
}

function subscribeGroup() {
  const groupId = val('sendGroupId') || val('groupId');
  if (!groupId) { wslog('ERROR: 请先填写群ID'); return; }
  if (!ws || ws.readyState !== 1) { wslog('ERROR: WS 未连接'); return; }
  const msg = { action: 'subscribe_group', data: { groupId } };
  ws.send(JSON.stringify(msg));
  wslog('→ 订阅群: ' + groupId);
}

function wsSendText(){ 
  if(!ws||ws.readyState!==1){ wslog('ERROR: WS 未连接'); return } 
  const t=val('payloadText'); 
  const convType=val('convType'); 
  const d={ 
    convId: val('convId')||'conv-demo', 
    convType, 
    clientMsgId: val('clientMsgId')||('cmid-'+Date.now()), 
    type:'text', 
    payload:{text:t} 
  }; 
  if(convType==='c2c') d.to=val('sendTo'); 
  else d.groupId=val('sendGroupId'); 
  const msg={action:'send', data:d}; 
  ws.send(JSON.stringify(msg)); 
  wslog('→ '+JSON.stringify(msg)); 
}

function startStream(){ 
  if(!ws||ws.readyState!==1){ wslog('ERROR: WS 未连接'); return } 
  const t=val('streamText'); 
  const convType=val('convType'); 
  const d={ 
    convId: val('convId')||'conv-demo', 
    convType, 
    clientMsgId: 'stream-'+Date.now(), 
    type:'stream', 
    payload:{text:t} 
  }; 
  if(convType==='c2c') d.to=val('sendTo'); 
  else d.groupId=val('sendGroupId'); 
  const msg={action:'start_stream', data:d}; 
  ws.send(JSON.stringify(msg)); 
  wslog('→ 开始流式: '+JSON.stringify(msg)); 
}

function sendChunk(){ 
  if(!ws||ws.readyState!==1){ wslog('ERROR: WS 未连接'); return } 
  const streamId=val('currentStreamId'); 
  if(!streamId){ wslog('ERROR: 无流 ID'); return; } 
  const delta=val('streamDelta'); 
  const msg={action:'stream_chunk', data:{streamId, delta}}; 
  ws.send(JSON.stringify(msg)); 
  wslog('→ 流片段: '+JSON.stringify(msg)); 
}

function endStream(){ 
  if(!ws||ws.readyState!==1){ wslog('ERROR: WS 未连接'); return } 
  const streamId=val('currentStreamId'); 
  if(!streamId){ wslog('ERROR: 无流 ID'); return; } 
  const finalText=val('streamText')+' [完成]'; 
  const msg={action:'end_stream', data:{streamId, finalText}}; 
  ws.send(JSON.stringify(msg)); 
  wslog('→ 结束流式: '+JSON.stringify(msg)); 
  setVal('currentStreamId', ''); 
  enableStreamBtns(false); 
}

// WebSocket 消息处理
function handleWSMessage(data) {
  try {
    const msg = JSON.parse(data);
    
    switch (msg.action) {
      case 'typing':
        handleTypingIndicator(msg.data);
        break;
      case 'mention':
        handleMention(msg.data);
        break;
      case 'call_incoming':
        currentCall = msg.data;
        setVal('currentCallId', currentCall.id);
        setVal('callStatus', '来电');
        updateCallButtons();
        wslog('📞 收到来电: ' + currentCall.fromUserId);
        // 被叫先准备本地流（在点击接听时也会再次获取）
        break;
      case 'call_started':
        currentCall = msg.data;
        setVal('currentCallId', currentCall.id);
        setVal('callStatus', '通话中');
        updateCallButtons();
        break;
      case 'call_answered':
        if (currentCall) {
          currentCall.status = 'connected';
          setVal('callStatus', '已接通');
          updateCallButtons();
          // 主叫方在对方接听后创建Offer
          if (currentCall.fromUserId === val('userId')) {
            createPeerConnection();
            if (localStream) {
              localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }
            (async ()=>{
              try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                const msg = { action: 'webrtc_signaling', data: { callId: currentCall.id, type: 'offer', sdp: offer.sdp, to: getOtherUserId() } };
                ws.send(JSON.stringify(msg));
                wslog('→ 发送Offer');
              } catch(e) { wslog('创建/发送Offer失败: '+e.message); }
            })();
          }
        }
        break;
      case 'call_rejected':
        cleanupCall();
        wslog('❌ 通话被拒接');
        break;
      case 'call_ended':
        cleanupCall();
        wslog('📵 通话已结束');
        break;
      case 'webrtc_signaling':
        handleSignalingMessage(msg.data);
        break;
      case 'stream_started':
        if (msg.data && msg.data.streamId) {
          setVal('currentStreamId', msg.data.streamId);
          enableStreamBtns(true);
        }
        break;
      case 'stream_ended':
        setVal('currentStreamId', '');
        enableStreamBtns(false);
        break;
    }
  } catch (e) {
    console.error('处理 WS 消息失败:', e);
  }
}

// 初始化连接状态
updateConnectionStatus(false);

// 初始化设备列表
document.addEventListener('DOMContentLoaded', () => {
  refreshDevices();
});
</script>
</body>
</html> 